<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace는 ClickDAOImpl에서 SqlSessionTemplate을 통해 호출할 때 사용되는 이름과 일치해야 
	합니다. ClickDAOImpl에서 정의한 NAMESPACE = "kr.co.dong.click.ClickMapper"를 사용합니다. -->
<mapper namespace="kr.co.dong.click.ClickMapper">

	<!-- ID: upsertClickHistory (DAO 인터페이스의 메서드 이름과 동일) 테이블 명: click_count SQL: 
		INSERT ... ON DUPLICATE KEY UPDATE를 사용한 UPSERT 구현 -->
	<insert id="upsertClickHistory"
		parameterType="kr.co.dong.click.ClickDTO">
		INSERT INTO click_count (
		user_id,
		deal_id,
		keyword,
		count
		)
		VALUES (
		#{userId},
		#{dealId},
		#{keyword},
		1  <!-- 최초 삽입 시 count는 1 -->
		)
		ON DUPLICATE KEY UPDATE
		-- 중복 발생 시 (user_id, deal_id 동일) count만 1 증가
		count = count + 1,
		-- 키워드는 최신 값으로 업데이트
		keyword = #{keyword}
		-- update_date는 DB 설정에 따라 자동 갱신됩니다.
	</insert>
	
	<!-- ✅ 그래프용 클릭 데이터 조회 -->
    <select id="getUserClick" parameterType="String" resultType="map">
        SELECT keyword, SUM(count) AS total_count
        FROM click_count
        WHERE user_id = #{userId}
        GROUP BY keyword
        ORDER BY total_count DESC
    </select>
</mapper>
